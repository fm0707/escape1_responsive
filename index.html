<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬å®¶å±‹è„±å‡ºã‚²ãƒ¼ãƒ  - å®¶å®ã‚’æ¢ã›</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
        }

        .game-container {
            width: 100vw;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .room-view {
            aspect-ratio: 1/1;           /* â†æ­£æ–¹å½¢ */
            width: 90vw;                 /* ç”»é¢å¹…ã®90% */
            max-width: 640px;            /* PCæ™‚æœ€å¤§ã‚µã‚¤ã‚º */
            max-height: 90vw;       
            background-size: cover;      /* â†coverã˜ã‚ƒãªãcontain */
            background-repeat: no-repeat;
            background-position: center center;
            position: relative;
            margin: 0 auto;
            cursor: crosshair;
            transition: background-image 0.5s ease-in-out;
        }

        #roomImage {
            width: 100%;
            height: 100%;
            object-fit: contain;    /* ç”»åƒå…¨ä½“ã‚’è¡¨ç¤º */
            position: absolute;
            left: 0;
            top: 0;
            z-index: 0;
            pointer-events: none;   /* ç”»åƒä¸Šã§ã‚‚ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒé€šã‚‹ã‚ˆã†ã« */
        }

        .clickable-area {
            position: absolute;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            z-index: 2;
            pointer-events: auto;

        }

        .clickable-area:hover {
            border-color: #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100vw;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 20px;
            width:100%;
        }

        .inventory-slot {
            width: 14vw; 
            height: 14vw; 
            max-width: 80px; 
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;   /* é‡‘è‰²ãƒ»å¤ªã‚æ¨å¥¨ */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .info-panel {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            height:80px;
            min-height: 40px;
            border: 1px solid #d4af37;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        /* ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;

        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="title">å®¶å®ã‚’æ¢ã› - æ—¥æœ¬å®¶å±‹ã‹ã‚‰ã®è„±å‡º</div>
        
        <div class="room-view" id="roomView">
            <!-- ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã¯å‹•çš„ã«ç”Ÿæˆ -->
              <img id="roomImage" src="">
        </div>

        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    å¤ã„æ—¥æœ¬å®¶å±‹ã«å…¥ã‚Šã¾ã—ãŸã€‚ã“ã®å®¶ã«ã¯ä»£ã€…å—ã‘ç¶™ãŒã‚Œã¦ããŸè²´é‡ãªå®¶å®ãŒéš ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†...
                </div>
                <div class="navigation">
                    <button class="nav-btn" onclick="changeRoom('genkan')">ç„é–¢</button>
                    <button class="nav-btn" onclick="changeRoom('living')">å±…é–“</button>
                    <button class="nav-btn" onclick="changeRoom('bedroom')">å¯å®¤</button>
                    <button class="nav-btn" onclick="changeRoom('study')">æ›¸æ–</button>
                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
            ğŸ”Š BGM
            </button> 
            
        </div>
        <div class="notice">å½“ã‚µã‚¤ãƒˆã¯OtoLogicã®ç´ æã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™</div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã¯å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>
    <audio id="bgm" src="sounds/musou.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-tv" src="sounds/TV-Hardware02-01(Button).mp3"></audio>
    <audio id="se-clear" src="sounds/Angel01-1.mp3"></audio>
    <script>
        // ã‚²ãƒ¼ãƒ è¨­å®š - ç”»åƒãƒ‘ã‚¹ã‚’ã“ã“ã§ç®¡ç†
        let IMAGES = {
            rooms: {
                genkan: 'images/genkan.jpg',        // ç„é–¢ã®ç”»åƒ
                living: 'images/living.jpg',        // å±…é–“ã®ç”»åƒ
                bedroom: 'images/bedroom.jpg',      // å¯å®¤ã®ç”»åƒ
                study: 'images/study.jpg'           // æ›¸æ–ã®ç”»åƒ
            },
            items: {
                key: 'images/key.jpg',              // éµã®ç”»åƒ
                scroll: 'images/scroll.jpg',        // å·»ç‰©ã®ç”»åƒ
                mirror: 'images/mirror.jpg',        // é¡ã®ç”»åƒ
                box: 'images/box.jpg',              // ç®±ã®ç”»åƒ
                treasure: 'images/treasure.jpg',    // å®¶å®ã®ç”»åƒ
                futonbo: 'images/futonbo.jpg',      // å¸ƒå›£ãŸãŸãã®ç”»åƒ
                smallKey: 'images/smallKey.jpg',    // å°ã•ã„éµã®ç”»åƒ
                book: 'images/book.jpg',            // çµµæœ¬ã®ç”»åƒ
            }
        };

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            currentRoom: 'genkan',
            currentChannel: 1,
            inventory: [],
            flags: {
                foundKey: false,
                foundMirror: false,
                readScroll: false,
                solvedPuzzle: false,
                foundTreasure: false,
                foundSmallKey: false,
                foundFutonbo: false,
                foundBear: false,
                happyBear: false,
                foundBook:false,
                watched1: false,
                watched2: false,
                watched3: false,
                watched4: false
            },
            selectedItem: null
        };

        // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿
        let patchX = 3
        let rooms = {
            genkan: {
                name: 'ç„é–¢',
                description: 'å¤ã„æ—¥æœ¬å®¶å±‹ã®ç„é–¢ã€‚é´ãŒæ•´ç„¶ã¨ä¸¦ã‚“ã§ã„ã‚‹ã€‚',
                clickableAreas: [
                    {
                        x: 19, y: 64, width: 25, height: 12,
                        action: 'examine_shoes',
                        description: 'å¤ã„ä¸‹é§„ã¨è‰å±¥ãŒä¸¦ã‚“ã§ã„ã‚‹'
                    },
                    {
                        x: 70, y: 50, width: 7, height: 22,
                        action: 'examine_umbrella',
                        description: 'ç•ªå‚˜ãŒç«‹ã¦ã‹ã‘ã‚‰ã‚Œã¦ã„ã‚‹'
                    },
                    {
                        x: 80, y: 35, width: 20, height: 63,
                        action: 'examine_bush',
                        description: 'èŒ‚ã¿ãŒã‚ã‚‹'
                    },
                    {
                        x: 0, y: 35, width: 20, height: 63,
                        action: 'examine_bush_left',
                        description: 'èŒ‚ã¿ãŒã‚ã‚‹'
                    },
                    {
                        x: 36, y: 26, width: 32, height: 38,
                        action: 'examine_door',
                        description: 'ç«‹æ´¾ãªæœ¨è£½ã®ãƒ‰ã‚¢'
                    },
                    {
                        x: 31, y: 36, width: 3, height: 10,
                        action: 'examine_plate',
                        description: 'è¡¨æœ­'
                    }
                ]
            },
            living: {
                name: 'å±…é–“',
                description: 'ç•³æ•·ãã®å±…é–“ã€‚å›²ç‚‰è£ã®è·¡ãŒã‚ã‚‹ã€‚',
                clickableAreas: [
                    {
                        x: 30, y: 76, width: 34, height: 16,
                        action: 'examine_fireplace',
                        description: 'å¤ã„å›²ç‚‰è£'
                    },
                    {
                        x: 58, y: 15, width: 11, height: 24,
                        action: 'examine_scroll',
                        description: 'æ›ã‘è»¸ãŒæ›ã‹ã£ã¦ã„ã‚‹'
                    },
                    {
                        x: 48, y: 46, width: 12, height: 13,
                        action: 'examine_chest',
                        description: 'å¤ã„æ¡ã®ç®ªç¬¥'
                    },
                    {
                        x: 20, y: 36, width: 20, height: 14,
                        action: 'examine_tv',
                        description: 'å¤ã„ãƒ†ãƒ¬ãƒ“'
                    },
                    {
                        x: 2, y: 63, width: 16, height: 10,
                        action: 'examine_livingbooks',
                        description: 'æœ¬'
                    },
                    {
                        x: 42, y: 64, width: 14, height: 10,
                        action: 'examine_nabe',
                        description: 'é‹'
                    },
                    {
                        x: 80, y: 90, width: 18, height: 10,
                        action: 'examine_zaisu',
                        description: 'åº§å¸ƒå›£'
                    },
                    {
                        x: 74, y: 10, width: 26, height: 50,
                        action: 'examine_shoji',
                        description: 'éšœå­'
                    }
                    
                ]
            },
            bedroom: {
                name: 'å¯å®¤',
                description: 'è³ªç´ ãªå¯å®¤ã€‚å¸ƒå›£ãŒç•³ã¾ã‚Œã¦ã„ã‚‹ã€‚',
                clickableAreas: [
                    {
                        x: 10, y: 65, width: 48, height: 20,
                        action: 'examine_futon',
                        description: 'ç¶ºéº—ã«ç•³ã¾ã‚ŒãŸå¸ƒå›£'
                    },
                    {
                        x: 28, y: 37, width: 10, height: 14,
                        action: 'examine_picture',
                        description: 'çµµç”»'
                    },
                    {
                        x: 62, y: 35, width: 11, height: 19,
                        action: 'examine_mirror',
                        description: 'å¤ã„éŠ…é¡ãŒç½®ã‹ã‚Œã¦ã„ã‚‹'
                    },
                    {
                        x: 80, y: 70, width: 3, height: 3,
                        action: 'examine_insect',
                        description: '?'
                    }
                ]
            },
            study: {
                name: 'æ›¸æ–',
                description: 'æœ¬ãŒãã£ã—ã‚Šã¨ä¸¦ã‚“ã æ›¸æ–ã€‚',
                clickableAreas: [
                    {
                        x: 14, y: 22, width: 18, height: 32,
                        action: 'examine_books',
                        description: 'å¤ã„æ›¸ç‰©ãŒä¸¦ã‚“ã§ã„ã‚‹'
                    },
                    {
                        x: 31, y: 22, width: 18, height: 32,
                        action: 'examine_books2',
                        description: 'å¤ã„æ›¸ç‰©ãŒä¸¦ã‚“ã§ã„ã‚‹'
                    },
                    {
                        x: 52, y: 22, width: 20, height: 32,
                        action: 'examine_books3',
                        description: 'å¤ã„æ›¸ç‰©ãŒä¸¦ã‚“ã§ã„ã‚‹'
                    },
                    {
                        x: 15, y: 68, width: 9, height: 10,
                        action: 'examine_piledbooks',
                        description: 'æœ¬ãŒç©ã¿é‡ã­ã‚‰ã‚Œã¦ã„ã‚‹'
                    },
                    {
                        x: 77, y: 48, width: 20, height: 20,
                        action: 'examine_safe',
                        description: 'é‡‘åº«ãŒã‚ã‚‹'
                    },
                    {
                        x: 80, y: 26, width: 8, height: 14,
                        action: 'examine_wallposter',
                        description: 'å£ã«æ›¸é¡ãŒè²¼ã‚‰ã‚Œã¦ã„ã‚‹'
                    }
                ]
            }
        };
        const initialLivingAreas = JSON.parse(JSON.stringify(rooms.living.clickableAreas));

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            changeRoom('genkan');
            updateMessage('å¤ã„æ—¥æœ¬å®¶å±‹ã«è¶³ã‚’è¸ã¿å…¥ã‚Œã¾ã—ãŸã€‚ã“ã®å®¶ã®ã©ã“ã‹ã«å®¶å®ãŒéš ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™...');
        }

        // éƒ¨å±‹ã‚’å¤‰æ›´
        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            // èƒŒæ™¯ç”»åƒã‚’è¨­å®šï¼ˆç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${IMAGES.rooms[roomId]})`;
            
            // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã‚’ç”Ÿæˆ
            generateClickableAreas(room);
            
            updateMessage(`${room.name}ã«å…¥ã‚Šã¾ã—ãŸã€‚${room.description}`);
        }

        // èƒŒæ™¯ç”»åƒã‚’å·®ã—æ›¿ãˆ
        function changeRoomImage(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            // èƒŒæ™¯ç”»åƒã‚’è¨­å®šï¼ˆç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${IMAGES.rooms[roomId]})`;
            generateClickableAreas(room);
        }

        // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã‚’ç”Ÿæˆ
        // 
        function generateClickableAreas(room) {
            const roomView = document.getElementById('roomView');

            roomView.innerHTML = '<img id="roomImage" src="'+IMAGES.rooms[gameState.currentRoom]+'" style="width:100%;height:100%;object-fit:contain;position:absolute;left:0;top:0;">';

            // ç”»åƒã®ãƒ­ãƒ¼ãƒ‰å¾Œã«é…ç½®
            const img = roomView.querySelector('#roomImage');
            img.onload = function() {

                room.clickableAreas.forEach(area => {
                    const clickableDiv = document.createElement('div');
                    clickableDiv.className = 'clickable-area';
                    clickableDiv.style.left   = (area.x) + '%';
                    clickableDiv.style.top    = (area.y) + '%';
                    clickableDiv.style.width  = (area.width) + '%';
                    clickableDiv.style.height = (area.height) + '%';
                    clickableDiv.style.position = 'absolute';
                    clickableDiv.onclick = () => handleAreaClick(area.action);
                    clickableDiv.title = area.description;

                    roomView.appendChild(clickableDiv);
                });
            };
            img.src = IMAGES.rooms[gameState.currentRoom]; // å¿…ãšç”»åƒã‚»ãƒƒãƒˆ
        }

        // ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleAreaClick(action) {
            switch(action) {
                case 'examine_shoes':
                    if (!gameState.flags.foundKey) {
                                updateMessage('å¤ã„ä¸‹é§„ã®ä¸­ã«å°ã•ãªéµãŒéš ã•ã‚Œã¦ã„ã¾ã—ãŸï¼');
                                addItem('key');
                        gameState.flags.foundKey=true;
                    } else {
                                updateMessage('å¤ã„ä¸‹é§„ãŒä¸¦ã‚“ã§ã„ã‚‹');
                        }
                                break;
                    
                case 'examine_umbrella':
                    updateMessage('ç•ªå‚˜ã®æŸ„ã«ä½•ã‹æ–‡å­—ãŒåˆ»ã¾ã‚Œã¦ã„ã‚‹...ã€Œæ±ã®é–“ã®é¡ã«æ˜ ã‚‹çœŸå®Ÿã€');
                    break;
                case 'examine_door':
                    updateMessage('å¤ã³ã¦ã„ã‚‹ãŒç«‹æ´¾ãªæœ¨è£½ã®ãƒ‰ã‚¢ã ');
                    break;
                case 'examine_plate':
                    updateMessage('è¡¨æœ­ã«å±‹æ•·ã®ä¸»ã®åå‰ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹');
                    break;
                case 'examine_bush_left':
                    updateMessage('ç·‘é®®ã‚„ã‹ãªèŒ‚ã¿ãŒã‚ã‚‹ã€‚ã•ã‚ã‚„ã‹ãªé¦™ã‚ŠãŒã™ã‚‹');
                    break;
                case 'examine_bush':
                    if (gameState.flags.watched3) {
                        showModal(
                            'èŒ‚ã¿ã®å¥¥ã«ã€é›ªã ã‚‹ã¾ã®åƒãŒéš ã•ã‚Œã¦ã„ãŸã€‚',
                            '<img src="images/snowman.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );
                        gameState.flags.foundSnowman = true;
                    } else {
                        updateMessage('ç·‘é®®ã‚„ã‹ãªèŒ‚ã¿ãŒã‚ã‚‹');
                    }
                    
                    break;   
                case 'examine_fireplace':
                    if (gameState.selectedItem=='futonbo') {
                        updateMessage('ãªã‚“ã¨ç°ã®ä¸­ã‹ã‚‰ã‚¯ãƒã®å¦–ç²¾ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼');
                        IMAGES.rooms.living = 'images/living2.jpg';
                        gameState.flags.foundBear = true;
  
                        rooms.living.clickableAreas.push({
                            x: 64, y: 60, width: 12, height: 15,
                            action: 'talkto_bear',
                            description: 'ã‚¯ãƒã¨è©±ã™'
                        });
                        changeRoomImage(gameState.currentRoom);
                    } else if(gameState.flags.foundBear){
                        updateMessage('å›²ç‚‰è£ã«ç°ãŒãŸã¾ã£ã¦ã„ã‚‹');
                    } else {
                        updateMessage('å›²ç‚‰è£ã®ç°ã®ä¸­ã«ä½•ã‹ãŒåŸ‹ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã ...');
                    }
                    break;
                case 'examine_scroll':
                    if (!gameState.flags.readScroll) {
                        showModal('å¤ã„å·»ç‰©', 'ã€Œå››ã¤ã®å­£ç¯€ãŒä¸€ã¤ã«ãªã‚‹æ™‚ã€çœŸã®å®ã¯ç¾ã‚Œã‚“ã€', [
                            {text: 'é–‰ã˜ã‚‹', action: 'close'}
                        ]);
                        gameState.flags.readScroll = true;
                        addItem('scroll');
                    } else {
                        updateMessage('ã™ã§ã«èª­ã‚“ã å·»ç‰©ã§ã™ã€‚');
                        showModal('å¤ã„å·»ç‰©', 'ã€Œå››ã¤ã®å­£ç¯€ãŒä¸€ã¤ã«ãªã‚‹æ™‚ã€çœŸã®å®ã¯ç¾ã‚Œã‚“ã€', [
                            {text: 'é–‰ã˜ã‚‹', action: 'close'}
                        ]);
                    }
                    break;
                case 'examine_picture':
                    if (gameState.flags.foundBear) {
                        showModal(
                            'å¤ã„çµµè‘‰æ›¸ãŒé¡ã®è£ã«è²¼ã£ã¦ã‚ã‚‹',
                            '<img src="images/momiji.png" style="width:200px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );
                    } else {
                        updateMessage('æ¤ç‰©ã®çµµç”»ã ã€‚');
                    }
                    break;
                     
                case 'examine_chest':
                    if (gameState.selectedItem=='key' && !gameState.flags.foundMirror) {
                        updateMessage('éµã‚’ä½¿ã£ã¦ç®ªç¬¥ã‚’é–‹ã‘ã¾ã—ãŸã€‚ä¸­ã‹ã‚‰å¤ã„æ‰‹é¡ãŒå‡ºã¦ãã¾ã—ãŸï¼');
                        addItem('mirror');
                        removeItem('key');
                        gameState.flags.foundMirror = true;
                        gameState.flags.isUsedKey = true;
                    } else if (!gameState.flags.isUsedKey){
                        updateMessage('ç®ªç¬¥ã«ã¯éµãŒã‹ã‹ã£ã¦ã„ã‚‹ã€‚éµãŒå¿…è¦ã ã€‚');
                    } else {
                        updateMessage('ç®ªç¬¥ã«ã¯ãŒã‚‰ããŸãŒå…¥ã£ã¦ã„ã‚‹ã€‚');
                    }
                    break;
                case 'examine_tv':
                    showTVModal();
                    break;  
                case 'examine_livingbooks':
                    if (gameState.flags.watched2 && gameState.flags.foundSnowman && !gameState.flags.foundBook) {
                        updateMessage('ã‚³ã‚°ãƒã®å¤§å†’é™ºã®çµµæœ¬ã‚’è¦‹ã¤ã‘ãŸ');
                        addItem('book');
                        gameState.flags.foundBook = true;
                    } else {
                        updateMessage('æœ¬ãŒä½•å†Šã‹ã‚ã‚‹');
                    }
                    break;  
                case 'examine_nabe':
                    updateMessage('é‹ã¯ç©ºã£ã½ã ');
                    break;  
                case 'examine_zaisu':
                    updateMessage('è‰²è¤ªã›ãŸåº§å¸ƒå›£ã ');
                    break;  
                case 'examine_shoji':
                    updateMessage('éšœå­ã¯å¤ã³ã¦ã„ã‚‹ãŒç©´ã¯é–‹ã„ã¦ã„ãªã„');
                    break;  
                case 'examine_futon':
                    if (!gameState.flags.foundFutonbo) {
                        addItem('futonbo');
                        updateMessage('å¸ƒå›£ãŸãŸãã®æ£’ã‚’ã¿ã¤ã‘ãŸã€‚');
                        gameState.flags.foundFutonbo = true;
                    } else {
                        updateMessage('å¸ƒå›£ã®ä¸‹ã«ä½•ã‚‚éš ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã ã€‚');
                    }
                    break;
                    
                case 'examine_mirror':
                    if (gameState.selectedItem=='mirror') {
                        updateMessage('æ‰‹é¡ã‚’ä½¿ã£ã¦éŠ…é¡ã‚’èª¿ã¹ã‚‹ã¨...éš ã•ã‚ŒãŸæ–‡å­—ãŒç¾ã‚ŒãŸï¼ã€Œé‡‘åº«ã®æ“ä½œãƒ‘ãƒãƒ«ã¯æ–‡å­—å…¥åŠ›å¯èƒ½ã€');
                        gameState.flags.solvedPuzzle = true;
                    } else if(!gameState.flags.solvedPuzzle) {
                        updateMessage('å¤ã„éŠ…é¡ã ãŒã€ä½•ã‹ç§˜å¯†ãŒã‚ã‚Šãã†ã ...');
                    } else {
                        updateMessage('å¤ã„éŠ…é¡ã«ã€ã€Œé‡‘åº«ã®æ“ä½œãƒ‘ãƒãƒ«ã¯æ–‡å­—å…¥åŠ›å¯èƒ½ã€ã¨ã„ã†æ–‡å­—ãŒæµ®ã‹ã‚“ã§ã„ã‚‹');
                    }
                    break;
                case 'examine_insect':
                    updateMessage('ã‚´ã‚­ãƒ–ãƒªã®æ­»éª¸ãŒè½ã¡ã¦ã„ã‚‹ã€‚');
                    break;    
                case 'examine_books':
                    if (gameState.currentChannel==1 && gameState.flags.watched1) {
                        updateMessage('ä½è³€ã®ãƒãƒ«ãƒ¼ãƒ³ãƒ•ã‚§ã‚¹ã‚¿ã«ã¤ã„ã¦ã®ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆã ã€‚å¤ã«é–‹å‚¬ã•ã‚Œã‚‹ã‚ˆã†ã ã€‚');
                    } else {
                        updateMessage('å¤ã„æ›¸ç‰©ãŒãŸãã•ã‚“ä¸¦ã‚“ã§ã„ã‚‹ã€‚ä½•ã‹æ‰‹ãŒã‹ã‚ŠãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚');
                    }
                    
                    break;
                case 'examine_piledbooks':
                    updateMessage('æ¡œã®èŠ±ã³ã‚‰ã®ã—ãŠã‚ŠãŒã¯ã•ã¾ã£ã¦ã„ã‚‹ã€‚èŠ±ã³ã‚‰ãŒ3æšé…ç½®ã•ã‚Œã¦ã„ã‚‹ã€‚');
                    break;
                    
                case 'examine_wallposter':
                    updateMessage('æ—¥ã€…å¥åº·ã«éã”ã™ãŸã‚ã®å¿ƒå¾—ãŒè²¼ã£ã¦ã‚ã‚‹');
                    break;  
                case 'examine_books2':
                    updateMessage('æ¤ç‰©ã«é–¢ã™ã‚‹æœ¬ãŒå¤šã„ã‚ˆã†ã ');
                    break;  
                case 'examine_books3':
                    updateMessage('ã‚¯ãƒã®å†¬çœ ã«é–¢ã™ã‚‹æœ¬ãŒã‚ã‚‹');
                    break;  
                case 'examine_safe':
                    if (gameState.flags.solvedPuzzle) {
                        showSeasonPuzzle();
                    } else {
                        updateMessage('é‡‘åº«ã«ã¯è¤‡é›‘ãªä»•æ›ã‘ãŒã‚ã‚‹ã€‚ã¾ã é–‹ã‘ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„ã€‚');
                    }
                    break;
                case 'talkto_bear':
                    if (gameState.selectedItem === 'futonbo') {
                        // ãƒãƒƒãƒ‰ã‚¨ãƒ³ãƒ‰æ¼”å‡º
                        showModal(
                            'ãƒãƒƒãƒ‰ã‚¨ãƒ³ãƒ‰',
                            '<img src="images/badend.jpg" style="width:300px;display:block;margin:0 auto 20px;">' +
                            '<br>ã‚ãªãŸã¯ã‚¯ãƒã®å¦–ç²¾ã‚’å¸ƒå›£ãŸãŸãã§å©ã„ã¦ã—ã¾ã£ãŸâ€¦<br><b>å®¶å®ã¯æ°¸é ã«å¤±ã‚ã‚ŒãŸã€‚</b><br><span style="color:#f00;">ã€ãƒãƒƒãƒ‰ã‚¨ãƒ³ãƒ‰ã€‘</span>',
                            [{text: 'æœ€åˆã‹ã‚‰', action: 'restart'}]
                        );
                        playSE('se-error');
                        break;
                    }
                    if (!gameState.flags.happyBear) {
                        updateMessage('æœ¬å½“ã®å®¶å®ã£ã¦ä½•ã‹çŸ¥ã£ã¦ã‚‹ï¼Ÿ');
                    } else {
                        updateMessage('ã¼ãã¯3å›å†¬çœ ã—ãŸã“ã¨ãŒã‚ã‚‹ã‚“ã ï¼');
                    }
                
                    if (gameState.selectedItem=='book' && gameState.currentChannel==2) {
                        updateMessage('å¦–ç²¾ã¯å–œã‚“ã§ã„ã‚‹ï¼');
                        IMAGES.rooms.living = 'images/living3.jpg';
                        gameState.flags.happyBear = true;
                        removeItem('book');
                        changeRoomImage(gameState.currentRoom);
                        
                    } 
                    break;
            }
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;
            playSE('se-click');
            updateInventoryDisplay();
        }

        // TV
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ç®¡ç†

        function changeChannel(dir) {
            playSE('se-tv'); // ã“ã“ã§çµ¶å¯¾é³´ã‚‹ï¼
            gameState.currentChannel += dir;
            if(gameState.currentChannel < 1) gameState.currentChannel = 4;
            if(gameState.currentChannel > 4) gameState.currentChannel = 1;
            if (gameState.currentChannel === 1) gameState.flags.watched1 = true;
            if (gameState.currentChannel === 2) gameState.flags.watched2 = true;
            if (gameState.currentChannel === 3) gameState.flags.watched3 = true;
            if (gameState.currentChannel === 4) gameState.flags.watched4 = true;
            renderTV(); // è¡¨ç¤ºæ›´æ–°
        }

        function renderTV() {
            let tvHint = [
                '1chï¼šãƒ‹ãƒ¥ãƒ¼ã‚¹ ã€Œä½è³€ãƒãƒ«ãƒ¼ãƒ³ãƒ•ã‚§ã‚¹ã‚¿é–‹å‚¬ã€',
                '2chï¼šã‚¢ãƒ‹ãƒ¡ ã€Œã‚³ã‚°ãƒã®å¤§å†’é™ºã€',
                '3chï¼šãƒŸã‚¹ãƒ†ãƒªãƒ¼ ã€ŒèŒ‚ã¿ã®ä¸­ã«æ½œã‚€ã®ã¯â€¦ã€',
                '4chï¼šå¤©æ°—äºˆå ± ã€Œæ˜æ—¥ã¯é›ªã ã‚‹ã¾æ³¨æ„ã€'
            ];
            let tvImg = [
                'ch1.jpg',
                'ch2.jpg',
                'ch3.jpg',
                'ch4.jpg',
            ];
            document.getElementById('modalContent').innerHTML =
                `<h3>ãƒ†ãƒ¬ãƒ“</h3>
                <img src="images/${tvImg[gameState.currentChannel-1]}" style="width:300px;display:block;margin:0 auto 20px;">
                <div style="margin-bottom:20px;">${tvHint[gameState.currentChannel-1]}</div>
                <button onclick="changeChannel(-1)">â—€</button>
                <span style="margin:0 10px;">${gameState.currentChannel}ch</span>
                <button onclick="changeChannel(1)">â–¶</button>
                <br><button onclick="closeModal()">é–‰ã˜ã‚‹</button>`;
            document.getElementById('modal').style.display = 'flex';
        }

        function showTVModal() {
            renderTV();
        }


        // å­£ç¯€ãƒ‘ã‚ºãƒ«ã‚’è¡¨ç¤º
        function showSeasonPuzzle() {
            const modalContent = `
                <h3>å…¥åŠ›ãƒ‘ãƒãƒ«</h3>
                <p>æ­£ã—ã„ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                <input type="text" class="puzzle-input" id="seasonInput" placeholder="æ•°å­—ã‚’å…¥åŠ›">
                <br>
                <button onclick="checkSeasonPuzzle()">ç¢ºèª</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // å­£ç¯€ãƒ‘ã‚ºãƒ«ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkSeasonPuzzle() {
            const input = document.getElementById('seasonInput').value;
            if (input === 'ï¼‘ï¼™' || input === '19') {
                closeModal();
                updateMessage('æ­£è§£ã§ã™ï¼é‡‘åº«ãŒé–‹ãã¾ã—ãŸï¼ä¸­ã‹ã‚‰ç¾ã—ã„å®¶å®ãŒç¾ã‚Œã¾ã—ãŸï¼');
                playSE('se-clear');
                showModal(
                    'ãƒãƒ¼ãƒãƒ«å®¶å®ç™ºè¦‹ï¼',
                    '<img src="images/treasure.jpg" style="width:300px;display:block;margin:0 auto 20px;"><br>è¦‹äº‹ã«ãƒãƒ¼ãƒãƒ«å®¶å®ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼<br>å¤ã„æ—¥æœ¬å®¶å±‹ã®ç§˜å¯†ã‚’è§£ãæ˜ã‹ã—ã¾ã—ãŸã­ã€‚',
                    [{text: 'æœ€åˆã‹ã‚‰', action: 'restart'}]
                );
                addItem('treasure');
                gameState.flags.foundTreasure = true;

            } else if (input === 'ï¼’ï¼’' || input === '22') {
                closeModal();
                updateMessage('æ­£è§£ã§ã™ï¼é‡‘åº«ãŒé–‹ãã¾ã—ãŸï¼ä¸­ã‹ã‚‰ç¾ã—ã„å®¶å®ãŒç¾ã‚Œã¾ã—ãŸï¼');
                playSE('se-clear');
                showModal(
                    'çœŸã®å®¶å®ç™ºè¦‹ï¼',
                    '<img src="images/treasure2.jpg" style="width:300px;display:block;margin:0 auto 20px;"><br>è¦‹äº‹ã«çœŸã®å®¶å®ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼<br>å¤ã„æ—¥æœ¬å®¶å±‹ã®ç§˜å¯†ã‚’è§£ãæ˜ã‹ã—ã¾ã—ãŸã­ã€‚',
                    [{text: 'æœ€åˆã‹ã‚‰', action: 'restart'}]
                );
                addItem('treasure');
                gameState.flags.foundTreasure = true;
                
            } else {
                playSE('se-error');
                updateMessage('é•ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã¦ãã ã•ã„ã€‚');
            }
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 5) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }
            
        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}ã‚’é¸æŠã—ã¾ã—ãŸã€‚ä½¿ç”¨ã—ãŸã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay(); 
            }
        }

        function getItemName(itemId) {
            const names = {
                key: 'éµ',
                scroll: 'å·»ç‰©',
                mirror: 'æ‰‹é¡',
                box: 'ç®±',
                treasure: 'å®¶å®',
                smallKey: 'å°ã•ã„éµ',
                futonbo: 'å¸ƒå›£ãŸãŸãã®æ£’',
                book: 'ã‚³ã‚°ãƒã®å¤§å†’é™ºã®çµµæœ¬',
            };
            return names[itemId] || itemId;
        }

        // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªè¡¨ç¤ºæ›´æ–°
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function() {
                        // ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                }
                // â˜…é¸æŠä¸­ãªã‚‰selectedã‚¯ãƒ©ã‚¹è¿½åŠ 
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
        function updateMessage(message) {
            document.getElementById('messageArea').innerHTML = message;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(title, content, buttons) {
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            buttons.forEach(button => {
                modalHtml += `<button onclick="${button.action === 'close' ? 'closeModal' : button.action === 'restart' ? 'restartGame()' : button.action}()">${button.text}</button>`;
            });
            
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
        function restartGame() {
            IMAGES.rooms.living = 'images/living.jpg';
            rooms.living.clickableAreas = JSON.parse(JSON.stringify(initialLivingAreas));
            gameState = {
                currentRoom: 'genkan',
                currentChannel: 1,
                inventory: [],
                flags: {
                    foundKey: false,
                    foundMirror: false,
                    readScroll: false,
                    solvedPuzzle: false,
                    foundTreasure: false,
                    foundSmallKey: false,
                    foundFutonbo: false,
                    foundBear: false,
                    happyBear: false,
                    foundBook:false,
                    watched1: false,
                    watched2: false,
                    watched3: false,
                    watched4: false
                },
                selectedItem: null,
                selectedItemSlot: null,
            };
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;   // â†ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å†ç”Ÿã—ã¦ãªã„
        let isBGMInitialized = false; // åˆå›ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç”¨

        // åˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã ã‘BGMã‚’å†ç”Ÿ
        function initBGMOnce() {
        if (!isBGMInitialized) {
            const bgm = document.getElementById('bgm');
            bgm.volume = 0.3;
            bgm.play();
            isBGMPlaying = true;
            isBGMInitialized = true;
            document.getElementById('bgm-toggle').textContent = "ğŸ”Š BGM";
        }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
        const bgm = document.getElementById('bgm');
        const btn = document.getElementById('bgm-toggle');
        if (!isBGMPlaying) {
            bgm.play();
            isBGMPlaying = true;
            btn.textContent = "ğŸ”Š BGM";
        } else {
            bgm.pause();
            isBGMPlaying = false;
            btn.textContent = "ğŸ”‡ BGM";
        }
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        initGame();
    </script>
</body>
</html>